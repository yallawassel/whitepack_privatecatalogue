<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>WhitePack Catalogue v8.2</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{--bg:#f5fff8;--accent:#166534;--card:#fff}
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:var(--bg);color:#213}
header{background:linear-gradient(90deg,#a6e8a6,#4ea84e);padding:14px;display:flex;justify-content:space-between;align-items:center}
.container{padding:16px}
.client-box{background:#fff;border-radius:10px;padding:10px;margin-bottom:12px}
input,select{width:100%;padding:8px;margin-top:4px;border-radius:6px;border:1px solid #ccc}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px}
.card{background:#fff;border-radius:12px;padding:10px;display:flex;flex-direction:column;box-shadow:0 2px 6px rgba(0,0,0,.06)}
.card-img{aspect-ratio:1/1;border:1px solid #e2e8f0;border-radius:10px;overflow:hidden}
.card-img img{width:100%;height:100%;object-fit:cover}
.price{font-weight:bold}
.cart-btn{margin-top:6px;background:#166534;color:#fff;border:none;border-radius:6px;padding:6px}
.cart{position:fixed;bottom:0;right:0;background:#fff;border-radius:12px 12px 0 0;width:100%;max-width:420px;box-shadow:0 -5px 20px rgba(0,0,0,.2);display:none;padding:10px}
.cart-item{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-size:14px}
</style>
</head>
<body>

<header>
  <strong>WhitePack</strong>
  <button onclick="openCart()">ðŸ›’ <span id="cartCount">0</span></button>
</header>

<div class="container">

<div class="client-box">
  <label>Client name</label>
  <input id="clientName" placeholder="Client name">
  <label>Phone number</label>
  <input id="clientPhone" placeholder="03xxxxxx">
</div>

<input id="search" placeholder="Search products..." oninput="render()">
<select id="categoryFilter" onchange="render()">
  <option value="">All categories</option>
</select>

<div id="grid" class="grid"></div>
</div>

<div id="cart" class="cart">
  <h3>Cart</h3>
  <div id="cartItems"></div>
  <div id="cartTotal" style="font-weight:bold;margin-top:6px"></div>
  <button onclick="sendWhatsApp()" class="cart-btn" style="width:100%">Send to WhatsApp</button>
</div>

<script>
const PRODUCTS_URL="products.json";
const SPECIAL_URL="special_prices.json";
const RATE=90000;

let products=[], specials=[], cart=[];

function normalizePhone(p){
 let c=String(p||"").replace(/\D/g,"");
 if(!c) return "";
 if(c.startsWith("961")) return c;
 c=c.replace(/^0+/,"");
 if(c.length<=8) c="961"+c;
 return c;
}

async function load(){
 products=await (await fetch(PRODUCTS_URL+"?t="+Date.now())).json();
 try{specials=await (await fetch(SPECIAL_URL+"?t="+Date.now())).json();}catch(e){specials=[];}
 buildCategories();
 render();
}
load();

document.getElementById("clientPhone").addEventListener("input", render);

function buildCategories(){
 const sel=document.getElementById("categoryFilter");
 sel.innerHTML='<option value="">All categories</option>';
 [...new Set(products.map(p=>p.category).filter(Boolean))].forEach(c=>{
  const o=document.createElement("option");
  o.value=c;o.textContent=c;
  sel.appendChild(o);
 });
}

function getVisibleProducts(){
 const phone=normalizePhone(clientPhone.value);
 let list=products;

 if(phone){
  const sp=specials.find(s=>normalizePhone(s.phone)===phone);
  if(sp){
   list=products.filter(p=>sp.products.some(x=>x.sku===p.sku))
    .map(p=>{
     const s=sp.products.find(x=>x.sku===p.sku);
     return {...p,price:s.price};
    });
  }
 }

 const q=search.value.toLowerCase();
 const cat=categoryFilter.value;

 return list.filter(p=>
  (!q||p.name.toLowerCase().includes(q)) &&
  (!cat||p.category===cat)
 );
}

function render(){
 const grid=document.getElementById("grid");
 grid.innerHTML="";
 getVisibleProducts().forEach(p=>{
  grid.innerHTML+=`
   <div class="card">
    <div class="card-img">
      <img src="${p.image||""}" onerror="this.style.display='none'">
    </div>
    <strong>${p.name}</strong>
    <div class="price">${p.price.toFixed(2)} USD</div>
    <input type="number" min="1" value="1" id="qty-${p.sku}">
    <button class="cart-btn" onclick='addToCart("${p.sku}")'>Add</button>
   </div>`;
 });
}

function addToCart(sku){
 const qty=parseInt(document.getElementById("qty-"+sku).value||1);
 const visible=getVisibleProducts().find(p=>p.sku===sku);
 if(!visible) return;

 const found=cart.find(i=>i.sku===sku);
 if(found){
  found.qty+=qty;
 }else{
  cart.push({sku:visible.sku,name:visible.name,price:visible.price,qty});
 }
 updateCart();
}

function updateCart(){
 cartCount.textContent=cart.reduce((s,i)=>s+i.qty,0);
 const box=document.getElementById("cartItems");
 let total=0;
 box.innerHTML="";
 cart.forEach(i=>{
  const line=i.qty*i.price;
  total+=line;
  box.innerHTML+=`
   <div class="cart-item">
    <span>${i.name}</span>
    <span>${i.qty} Ã— ${i.price.toFixed(2)}</span>
   </div>`;
 });
 cartTotal.textContent="Total: "+total.toFixed(2)+" USD ("+(Math.round(total*RATE)).toLocaleString()+" LBP)";
}

function openCart(){
 cart.style.display="block";
 updateCart();
}

function sendWhatsApp(){
 if(!cart.length){alert("Cart is empty");return;}
 let total=0;
 let msg="Client: "+(clientName.value||"Unknown")+"\n";
 msg+="Phone: "+normalizePhone(clientPhone.value)+"\n\n";
 cart.forEach(i=>{
  const line=i.qty*i.price;
  total+=line;
  msg+=`- ${i.name} Ã— ${i.qty} = ${line.toFixed(2)} USD\n`;
 });
 msg+="\nTotal: "+total.toFixed(2)+" USD";
 window.open("https://wa.me/96181085811?text="+encodeURIComponent(msg),"_blank");
}
</script>
</body>
</html>
